<script>
const files = [
  "Aliyem.html", "Ana_Dina.html", "Cem_ve_Neslihane_ra.html",
  "DÄ±_BudelaÃª_Suke_Bava_Bertal_ve_SewÅŸÃªni_ra.html", "Emina_Ã‡Ãªna_DÄ±le_AlÃª_Qeri.html",
  "Estemol.html", "Fide.html", "KÄ±lÄ±te_Dersimi.html", "LÃ¼ye_ve_HeyvanunÃª_GÃªme_ra.html",
  "QewÄŸa_AlunÃª_Demenu.html", "Sawci_Ã§ay_simenÃª.html", "Sey_MomÄ±d.html",
  "Sey_Qaji.html", "SÄ±lemano_QÄ±c.html", "SÄ±lÃª_Phiti.html",
  "Ters_u_XofÃª_Elife_ve_Ã‡Ãªnu_ra.html", "VÄ±lÃª_Zini_de_astÄ±kÃª_ma_serde_Ã§inÃª.html",
  "Xana_Feqire.html", "Yemose_ve_XÄ±dÄ±ri_ra.html", "Cemila Ã‡Ãªna ÅžÄ±x Heseni.html"
];
const results = [];

window.onload = () => {
  const filter = document.getElementById("fileFilter");
  files.forEach(f => {
    const opt = document.createElement("option");
    opt.value = f; opt.textContent = f;
    filter.appendChild(opt);
  });
};

async function performSearch() {
  const wordQuery = document.getElementById("wordInput").value.toLowerCase().trim();
  const annotationQuery = document.getElementById("annotationInput").value.toLowerCase().trim();
  const fileFilter = document.getElementById("fileFilter").value;

  results.length = 0;

  const selectedFiles = fileFilter ? [fileFilter] : files;

  for (const file of selectedFiles) {
    const res = await fetch(file);
    const html = await res.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");
    const spans = doc.querySelectorAll("span.annotated");

    spans.forEach((span, i) => {
      const word = span.childNodes[0]?.textContent?.trim() || "";
      const annotation = span.querySelector(".tooltip-box")?.textContent?.trim() || "";
      if (
        (!wordQuery || word.toLowerCase().includes(wordQuery)) &&
        (!annotationQuery || annotation.toLowerCase().includes(annotationQuery))
      ) {
        let sentenceEl = span.closest("span.sentence");
        let sentenceHTML = sentenceEl ? sentenceEl.innerHTML : span.outerHTML;
        let sentenceText = sentenceEl ? sentenceEl.textContent : span.textContent;

        // Highlight the word in the context (if found)
        // Use a RegExp for global, case-insensitive matching
        let kwicHTML;
        if (wordQuery) {
          const re = new RegExp(`(${wordQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
          kwicHTML = sentenceHTML.replace(re, "<span class='kwic-hit'>$1</span>");
        } else {
          kwicHTML = sentenceHTML;
        }

        results.push({ file, word, annotation, context: kwicHTML, sentence: sentenceText });
      }
    });
  }

  showResults(results);
  showStats(results);
}

function showResults(data) {
  const container = document.getElementById("results");
  if (data.length === 0) {
    container.innerHTML = "<p>No results found.</p>";
    document.getElementById("stats").innerHTML = "";
    return;
  }
  let html = "<table><tr><th>Text</th><th>Word</th><th>Annotation</th><th>KWIC</th></tr>";
  for (const r of data) {
    html += `<tr>
      <td>${r.file}</td>
      <td>${r.word}</td>
      <td>${r.annotation}</td>
      <td>${r.context}<br><span style='color: #555; font-size: 0.95em; display:block; margin-top:0.5em;'><i>Sentence: ${r.sentence}</i></span></td>
    </tr>`;
  }
  html += "</table>";
  container.innerHTML = html;
}

function showStats(data) {
  const container = document.getElementById("stats");
  const freq = {};
  data.forEach(r => {
    r.annotation.split("|").forEach(a => {
      const key = a.trim();
      if (key) freq[key] = (freq[key] || 0) + 1;
    });
  });
  let html = "<h2>ðŸ“Š Annotation Statistics</h2><ul>";
  for (const [ann, count] of Object.entries(freq)) {
    html += `<li><b>${ann}</b>: ${count}</li>`;
  }
  html += "</ul>";
  container.innerHTML = html;
}

function exportResults(format) {
  if (results.length === 0) return alert("No results to export.");
  if (format === "csv") {
    let csv = "Text,Word,Annotation,KWIC,Sentence\n";
    results.forEach(r => {
      csv += `"${r.file}","${r.word}","${r.annotation}","${r.context.replace(/"/g, '""')}","${r.sentence.replace(/"/g, '""')}"\n`;
    });
    download("search_results.csv", csv);
  } else {
    download("search_results.json", JSON.stringify(results, null, 2));
  }
}

function download(filename, content) {
  const blob = new Blob([content], { type: "text/plain" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}
</script>
